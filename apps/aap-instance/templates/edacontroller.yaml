{{- if .Values.edaController.enabled }}
{{- if not (empty .Values.edaController.admin.password) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.edaController.name }}-admin-password
  namespace: {{ .Values.edaController.namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.edaController.name }}
    app.kubernetes.io/part-of: ansible-automation-platform
    app.kubernetes.io/managed-by: gitops
  annotations:
    argocd.argoproj.io/sync-wave: "0"
type: Opaque
stringData:
  password: {{ .Values.edaController.admin.password | quote }}
---
{{- end }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.edaController.name }}-password-generator
  namespace: {{ .Values.edaController.namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.edaController.name }}
    app.kubernetes.io/part-of: ansible-automation-platform
    app.kubernetes.io/managed-by: gitops
    component: password-generator
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ .Values.automation.serviceAccount.name }}
      containers:
      - name: password-generator
        image: {{ .Values.automation.image.repository }}:{{ .Values.automation.image.tag }}
        imagePullPolicy: {{ .Values.automation.image.pullPolicy }}
        command: ["bash", "-c"]
        args:
        - |
          {{- if empty .Values.edaController.admin.password }}
          # Generate password only if secret doesn't exist and no password provided
          if ! oc get secret {{ .Values.edaController.name }}-admin-password -n {{ .Values.edaController.namespace }} >/dev/null 2>&1; then
            PASSWORD=$(openssl rand -base64 16)
            oc create secret generic {{ .Values.edaController.name }}-admin-password \
              --from-literal=password="$PASSWORD" \
              -n {{ .Values.edaController.namespace }}
            echo "Generated admin password for {{ .Values.edaController.name }}"
          else
            echo "Admin password secret already exists"
          fi
          {{- else }}
          echo "Using provided admin password"
          {{- end }}
---
apiVersion: eda.ansible.com/v1alpha1
kind: EDAController
metadata:
  name: {{ .Values.edaController.name }}
  namespace: {{ .Values.edaController.namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.edaController.name }}
    app.kubernetes.io/part-of: ansible-automation-platform
    app.kubernetes.io/managed-by: gitops
  annotations:
    argocd.argoproj.io/sync-wave: "20"
spec:
  route_tls_termination_mechanism: Edge
  ingress_type: Route
  loadbalancer_port: 80
  loadbalancer_protocol: http
  
  # Admin configuration
  admin_user: {{ .Values.edaController.admin.username }}
  admin_email: {{ .Values.edaController.admin.email }}
  admin_password_secret: {{ .Values.edaController.name }}-admin-password
  
  # PostgreSQL configuration
  {{- if .Values.edaController.postgres.external.enabled }}
  # External PostgreSQL configuration
  postgres_configuration_secret: {{ .Values.edaController.postgres.external.secretName | default (printf "%s-postgres-configuration" .Values.edaController.name) }}
  {{- else }}
  # Internal PostgreSQL configuration
  postgres_storage_requirements:
    requests:
      storage: {{ .Values.edaController.postgres.internal.storage.size }}
    {{- if .Values.edaController.postgres.internal.storage.storageClass }}
    storageClassName: {{ .Values.edaController.postgres.internal.storage.storageClass }}
    {{- end }}
  
  postgres_resource_requirements:
    requests:
      cpu: {{ .Values.edaController.postgres.internal.resources.requests.cpu }}
      memory: {{ .Values.edaController.postgres.internal.resources.requests.memory }}
    limits:
      cpu: {{ .Values.edaController.postgres.internal.resources.limits.cpu }}
      memory: {{ .Values.edaController.postgres.internal.resources.limits.memory }}
  {{- end }}
  
  # API resource configuration
  api_resource_requirements:
    requests:
      cpu: {{ .Values.edaController.resources.requests.cpu }}
      memory: {{ .Values.edaController.resources.requests.memory }}
    limits:
      cpu: {{ .Values.edaController.resources.limits.cpu }}
      memory: {{ .Values.edaController.resources.limits.memory }}
  
  # Default worker resource configuration
  default_worker_resource_requirements:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"
  
  # Activation worker resource configuration
  activation_worker_resource_requirements:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"
  
  # UI resource configuration
  ui_resource_requirements:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"
  
  # Scheduler resource configuration
  scheduler_resource_requirements:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"
  
  # Redis resource configuration
  redis_resource_requirements:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"
  
  # Node selector, tolerations, and affinity
  {{- with .Values.automation.nodeSelector }}
  node_selector: {{ toYaml . | nindent 4 }}
  {{- end }}
  
  {{- with .Values.automation.tolerations }}
  tolerations: {{ toYaml . | nindent 4 }}
  {{- end }}
  
  {{- with .Values.automation.affinity }}
  affinity: {{ toYaml . | nindent 4 }}
  {{- end }}
{{- end }}
